# é˜²æ­¢æ•æ„Ÿè³‡è¨Šæ´©æ¼æŒ‡å—

## ğŸ›¡ï¸ è‡ªå‹•åŒ–é˜²è­·æªæ–½

### 1. Git Hooksï¼ˆæ¨è–¦ï¼‰

#### Pre-commit Hook - é˜»æ­¢æäº¤æ•æ„Ÿè³‡è¨Š

å»ºç«‹ `.git/hooks/pre-commit`ï¼š

```bash
#!/bin/bash
# æ•æ„Ÿè³‡è¨Šæª¢æŸ¥

# å®šç¾©æ•æ„Ÿé—œéµå­—æ¨¡å¼
SENSITIVE_PATTERNS=(
  "glpat-[a-zA-Z0-9_-]+"              # GitLab Token
  "gitlab\..*\.com"                    # å…¬å¸ GitLab URL
  "[a-zA-Z0-9._%+-]+@(?!example\.com)" # çœŸå¯¦ Emailï¼ˆæ’é™¤ç¯„ä¾‹ï¼‰
  "password\s*=\s*['\"][^'\"]+['\"]"  # æ˜æ–‡å¯†ç¢¼
)

# æª¢æŸ¥æš«å­˜å€æª”æ¡ˆ
for pattern in "${SENSITIVE_PATTERNS[@]}"; do
  if git diff --cached | grep -E "$pattern" > /dev/null; then
    echo "âŒ éŒ¯èª¤ï¼šç™¼ç¾å¯èƒ½çš„æ•æ„Ÿè³‡è¨Šï¼"
    echo "æ¨¡å¼ï¼š$pattern"
    echo ""
    echo "è«‹ç§»é™¤æ•æ„Ÿè³‡è¨Šå¾Œå†æäº¤ï¼Œæˆ–ä½¿ç”¨ git commit --no-verify è·³éæª¢æŸ¥"
    exit 1
  fi
done

echo "âœ… æ•æ„Ÿè³‡è¨Šæª¢æŸ¥é€šé"
exit 0
```

### 2. git-secrets å·¥å…·ï¼ˆå¼·çƒˆæ¨è–¦ï¼‰

```bash
# å®‰è£
brew install git-secrets

# åˆå§‹åŒ–ï¼ˆåœ¨å°ˆæ¡ˆç›®éŒ„åŸ·è¡Œï¼‰
git secrets --install
git secrets --register-aws  # AWS keys

# æ·»åŠ è‡ªè¨‚è¦å‰‡
git secrets --add 'glpat-[a-zA-Z0-9_-]+'
git secrets --add 'gitlab\.[^\.]+\.com'
git secrets --add '[0-9]{2,3}\.[0-9]{2,3}\.[0-9]{1,3}\.[0-9]{1,3}'  # IP

# æƒæç¾æœ‰æ­·å²
git secrets --scan-history
```

### 3. .gitignore ç¯„æœ¬ï¼ˆå·²å®Œæˆ âœ“ï¼‰

ç¢ºä¿ `.gitignore` åŒ…å«ï¼š

```gitignore
# ç’°å¢ƒè®Šæ•¸
.env
.env.*
!.env.example

# é…ç½®æª”æ¡ˆ
.gitlab-analysis.yml
.gitlab-analysis.*.yml
*.secret.*

# é–‹ç™¼æ­·å²
.specstory/
.cursor/
.aider*

# IDE è¨­å®š
.vscode/settings.json
.idea/workspace.xml
```

### 4. ç’°å¢ƒè®Šæ•¸ç¯„æœ¬ç³»çµ±

**æ­¥é©Ÿ 1ï¼šå»ºç«‹ç¯„æœ¬æª”æ¡ˆ**
```bash
# .env.exampleï¼ˆå¯æäº¤ï¼‰
GITLAB_TOKEN=your_token_here
GITLAB_HOST=https://gitlab.com
GITLAB_PROJECT=example/project
```

**æ­¥é©Ÿ 2ï¼šè‡ªå‹•é©—è­‰è…³æœ¬**
å»ºç«‹ `scripts/validate-env.sh`ï¼š

```bash
#!/bin/bash
# é©—è­‰ .env æª”æ¡ˆä¸åŒ…å«æ•æ„Ÿè³‡è¨Š

if [ -f .env ]; then
  # æª¢æŸ¥æ˜¯å¦åŒ…å«ç¯„ä¾‹å€¼
  if grep -q "your_token_here\|example\.com\|example/project" .env; then
    echo "âœ… .env ä½¿ç”¨ç¯„ä¾‹å€¼ï¼Œå®‰å…¨"
  else
    echo "âš ï¸  .env åŒ…å«çœŸå¯¦å€¼ï¼Œè«‹å‹¿æäº¤ï¼"

    # æª¢æŸ¥æ˜¯å¦åœ¨ git ä¸­
    if git ls-files --error-unmatch .env 2>/dev/null; then
      echo "âŒ éŒ¯èª¤ï¼š.env å·²è¢« Git è¿½è¹¤ï¼"
      echo "åŸ·è¡Œ: git rm --cached .env"
      exit 1
    fi
  fi
fi
```

## ğŸ” å®šæœŸæª¢æŸ¥å·¥å…·

### 1. Gitleaksï¼ˆé–‹æºå·¥å…·ï¼‰

```bash
# å®‰è£
brew install gitleaks

# æƒæç•¶å‰å°ˆæ¡ˆ
gitleaks detect --source . --verbose

# æƒææ•´å€‹æ­·å²
gitleaks detect --source . --log-opts="--all"

# CI/CD æ•´åˆ
gitleaks detect --source . --report-path gitleaks-report.json
```

### 2. æ‰‹å‹•æª¢æŸ¥è…³æœ¬

å»ºç«‹ `scripts/check-secrets.sh`ï¼š

```bash
#!/bin/bash
# å¿«é€Ÿæª¢æŸ¥æ•æ„Ÿè³‡è¨Š

echo "ğŸ” æƒææ•æ„Ÿè³‡è¨Š..."

# æª¢æŸ¥æª”æ¡ˆå…§å®¹
echo "1. æª¢æŸ¥æª”æ¡ˆå…§å®¹..."
grep -rn "glpat-\|password\s*=\|api[_-]key" \
  --include="*.ts" --include="*.js" --include="*.md" \
  --exclude-dir=node_modules --exclude-dir=.git \
  . 2>/dev/null && echo "âŒ ç™¼ç¾å¯ç–‘å…§å®¹" || echo "âœ… é€šé"

# æª¢æŸ¥ Git æ­·å²
echo "2. æª¢æŸ¥ Git commit è¨Šæ¯..."
git log --all --pretty=format:"%s %b" | \
  grep -iE "(password|token|secret|key)" | \
  wc -l | \
  xargs -I {} echo "æ‰¾åˆ° {} å€‹å¯ç–‘ commit"

# æª¢æŸ¥æ˜¯å¦æœ‰ .env è¢«è¿½è¹¤
echo "3. æª¢æŸ¥ .env æª”æ¡ˆ..."
git ls-files | grep "\.env$" && \
  echo "âŒ .env è¢« Git è¿½è¹¤ï¼" || \
  echo "âœ… .env æœªè¢«è¿½è¹¤"

echo "âœ… æª¢æŸ¥å®Œæˆ"
```

## ğŸ“‹ åœ˜éšŠå”ä½œè¦ç¯„

### 1. Code Review Checklist

**å¯©æŸ¥è€…å¿…é ˆæª¢æŸ¥ï¼š**
- [ ] æ²’æœ‰ç¡¬ç·¨ç¢¼çš„ tokens/passwords
- [ ] æ²’æœ‰å…§éƒ¨ URLs/IPs
- [ ] æ²’æœ‰çœŸå¯¦çš„å…¬å¸/å°ˆæ¡ˆåç¨±
- [ ] ç’°å¢ƒè®Šæ•¸ä½¿ç”¨ `.env` è€Œéç¡¬ç·¨ç¢¼
- [ ] æ¸¬è©¦è³‡æ–™ä½¿ç”¨å‡åï¼ˆexample.comï¼‰

### 2. PR ç¯„æœ¬

å»ºç«‹ `.github/pull_request_template.md`ï¼š

```markdown
## å®‰å…¨æ€§æª¢æŸ¥æ¸…å–®

- [ ] æˆ‘å·²ç¢ºèªæ²’æœ‰æäº¤ä»»ä½•æ•æ„Ÿè³‡è¨Šï¼ˆtokens, passwords, å…§éƒ¨ URLsï¼‰
- [ ] æˆ‘å·²ç¢ºèªæ²’æœ‰åŒ…å«çœŸå¯¦çš„å…¬å¸/å°ˆæ¡ˆåç¨±
- [ ] æˆ‘å·²ä½¿ç”¨ `.env` ç®¡ç†æ‰€æœ‰é…ç½®è³‡è¨Š
- [ ] æˆ‘å·²åŸ·è¡Œ `scripts/check-secrets.sh` ä¸¦é€šéæª¢æŸ¥
```

### 3. æ–°æˆå“¡åŸ¹è¨“æ¸…å–®

```markdown
# æ–°æˆå“¡å…¥è·æª¢æŸ¥æ¸…å–®

é–‹ç™¼å‰å¿…é ˆå®Œæˆï¼š
1. [ ] å®‰è£ git-secrets: `brew install git-secrets`
2. [ ] è¨­å®š pre-commit hook
3. [ ] è¤‡è£½ .env.example ç‚º .env ä¸¦å¡«å…¥å€‹äºº token
4. [ ] ç¢ºèª .env åœ¨ .gitignore ä¸­
5. [ ] é–±è®€ .git-secrets-prevention.md
```

## ğŸ¤– CI/CD æ•´åˆ

### GitHub Actions ç¯„ä¾‹

å»ºç«‹ `.github/workflows/security-check.yml`ï¼š

```yaml
name: Security Check

on: [push, pull_request]

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œæ•´æ­·å²

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for .env files
        run: |
          if git ls-files | grep -E "^\.env$"; then
            echo "âŒ Error: .env file is tracked by git!"
            exit 1
          fi
          echo "âœ… No .env files tracked"
```

## ğŸš¨ æ„å¤–æ´©æ¼æ‡‰æ€¥è™•ç†

### å¿«é€Ÿè™•ç†æµç¨‹

1. **ç«‹å³æ’¤éŠ· Token**
   ```bash
   # å‰å¾€ GitLab ç«‹å³æ’¤éŠ· token
   # Settings > Access Tokens > Revoke
   ```

2. **è©•ä¼°å½±éŸ¿ç¯„åœ**
   ```bash
   # æª¢æŸ¥ token å‡ºç¾åœ¨å“ªäº› commits
   git log --all -S "glpat-xxxxx" --source --all
   ```

3. **ä½¿ç”¨æœ¬æŒ‡å—çš„æ¸…ç†æ­¥é©Ÿ**
   - ä½¿ç”¨ git filter-branch æˆ– git-filter-repo
   - å¼·åˆ¶æ¨é€åˆ°æ‰€æœ‰åˆ†æ”¯
   - é€šçŸ¥æ‰€æœ‰å”ä½œè€…é‡æ–° clone

4. **è¨˜éŒ„äº‹ä»¶**
   - è¨˜éŒ„æ´©æ¼æ™‚é–“
   - è¨˜éŒ„å½±éŸ¿ç¯„åœ
   - è¨˜éŒ„è™•ç†æ­¥é©Ÿ

## ğŸ“š æ¨è–¦å·¥å…·æ¸…å–®

| å·¥å…· | ç”¨é€” | å®‰è£ |
|------|------|------|
| git-secrets | è‡ªå‹•æª¢æ¸¬ AWS/é€šç”¨ secrets | `brew install git-secrets` |
| gitleaks | å…¨é¢çš„ secrets æƒæ | `brew install gitleaks` |
| detect-secrets | Python ç’°å¢ƒ secrets æª¢æ¸¬ | `pip install detect-secrets` |
| trufflehog | æ·±åº¦æƒæ Git æ­·å² | `brew install trufflehog` |

## âœ… æ¯é€±æª¢æŸ¥æ¸…å–®

```bash
# è¤‡è£½æ­¤è…³æœ¬åˆ° scripts/weekly-check.sh

#!/bin/bash
echo "ğŸ”’ æ¯é€±å®‰å…¨æª¢æŸ¥"

# 1. æƒææ–°å¢çš„æª”æ¡ˆ
git diff main --name-only | while read file; do
  if [[ $file == *.env ]]; then
    echo "âš ï¸  ç™¼ç¾ .env æª”æ¡ˆè®Šæ›´"
  fi
done

# 2. æª¢æŸ¥æœ€è¿‘ 7 å¤©çš„ commits
git log --since="7 days ago" --pretty=format:"%s" | \
  grep -iE "(password|token|secret)" && \
  echo "âš ï¸  æœ€è¿‘çš„ commits åŒ…å«æ•æ„Ÿé—œéµå­—"

# 3. åŸ·è¡Œ gitleaks
gitleaks detect --source . --verbose

echo "âœ… æ¯é€±æª¢æŸ¥å®Œæˆ"
```

## ğŸ¯ æœ€ä½³å¯¦è¸ç¸½çµ

1. **æ°¸é ä¸è¦**ï¼š
   - âŒ ç¡¬ç·¨ç¢¼ tokens/passwords
   - âŒ æäº¤ .env æª”æ¡ˆ
   - âŒ åœ¨ commit è¨Šæ¯ä¸­å¯«å…¥æ•æ„Ÿè³‡è¨Š
   - âŒ ä½¿ç”¨çœŸå¯¦çš„å…¬å¸/å°ˆæ¡ˆåç¨±åšæ¸¬è©¦

2. **å‹™å¿…è¦**ï¼š
   - âœ… ä½¿ç”¨ .env.example ç¯„æœ¬
   - âœ… è¨­å®š git hooks
   - âœ… å®šæœŸåŸ·è¡Œå®‰å…¨æƒæ
   - âœ… Code review æª¢æŸ¥å®‰å…¨æ€§
   - âœ… ä½¿ç”¨å‡åæ¸¬è©¦è³‡æ–™ï¼ˆexample.comï¼‰

3. **é¤Šæˆç¿’æ…£**ï¼š
   - æäº¤å‰åŸ·è¡Œ `git diff --cached`
   - ä½¿ç”¨ `git add -p` é€å¡Šæª¢æŸ¥
   - å®šæœŸåŸ·è¡Œ `gitleaks detect`
